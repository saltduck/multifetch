# Postprocess 功能需求文档

## 1. 概述

Postprocess功能，用于对从各种数据源（API、区块链、HTTP请求等）获取的原始数据进行后处理和格式化。该功能允许用户通过配置化的方式对数据进行转换、计算和格式化，以满足不同的显示需求。

## 2. 功能目标

### 2.1 主要目标
- 提供灵活的数据后处理能力，支持多种数据类型和操作
- 简化复杂数据的提取和转换过程
- 支持链式操作，允许对数据进行多步骤处理
- 提供错误处理机制，确保系统稳定性

### 2.2 业务价值
- 减少硬编码的数据处理逻辑
- 支持快速添加新的数据源
- 提供统一的数据处理接口

## 3. 功能需求

### 3.1 支持的数据操作类型

#### 3.1.1 JSON 数据提取
- **功能描述**: 从 JSON 响应中提取指定路径的数据
- **语法**: `json:path.to.property`
- **示例**: 
  - `json:data.floor_price` - 提取 data.floor_price 的值
  - `json:0.airdrop_stake_counts` - 提取数组第一个元素的 airdrop_stake_counts 属性

#### 3.1.2 数学运算
- **除法运算**: `div:number`
  - 将当前值除以指定数字
  - 示例: `div:100000000` - 将值除以 100000000（常用于单位转换）
- **乘法运算**: `mul:number`
  - 将当前值乘以指定数字
  - 示例: `mul:100` - 将值乘以 100
- **加法运算**: `add:number`
  - 将当前值加上指定数字
  - 示例: `add:1000` - 将值加上 1000
- **减法运算**: `sub:number`
  - 将当前值减去指定数字
  - 示例: `sub:500` - 将值减去 500

#### 3.1.3 数据类型转换
- **数字转换**: `toNumber`
  - 将字符串转换为整数
  - 示例: 将 "123" 转换为 123

#### 3.1.4 对象属性提取
- **功能描述**: 从对象中提取指定路径的属性值
- **语法**: `object:path.to.property`
- **示例**: `object:result` - 提取对象的 result 属性

### 3.2 链式操作支持

#### 3.2.1 数组配置格式
- 支持将多个操作组合成数组形式
- 操作按顺序执行，前一个操作的输出作为下一个操作的输入
- 示例: `["object:result", "toNumber", "div:100"]`

#### 3.2.2 单操作格式
- 支持单个操作的字符串格式
- 示例: `json:amount`

### 3.3 错误处理

#### 3.3.1 异常捕获
- 捕获所有后处理过程中的异常
- 记录错误日志到控制台
- 处理失败时返回原始值，确保系统稳定性

#### 3.3.2 数据验证
- 验证数学运算的操作数是否为有效数字
- 验证 JSON 解析的有效性
- 验证对象属性提取的路径是否存在

## 4. 配置示例

### 4.1 简单 JSON 提取
```json
{
  "type": "http-post",
  "params": {
    "url": "https://transcription-service.bihelix.io/all_stake_btc_amount",
    "postprocess": "json:amount"
  }
}
```

### 4.2 链式操作
```json
{
  "type": "call",
  "params": {
    "chainid": 56,
    "contract": "0x5fC1c0121Cd0438f78e31EA20422c09eaFfcC068",
    "data": "0x6a8a5f3d0000000000000000000000000000000000000000000000000000000000000000",
    "postprocess": ["object:result", "toNumber", "div:100"]
  }
}
```

### 4.3 复杂数据处理
```json
{
  "type": "http-get",
  "params": {
    "url": "https://bazaar-api.bihelix.io/api/assets/rgb:nykNCHhT-BgKdtCi-ilF89kf-JilBhg0-JfInd9k-7MyyYOE",
    "postprocess": ["json:data.floor_price", "div:100000000"]
  }
}
```

## 5. 扩展性需求

### 5.1 新增操作类型
- 支持添加新的数据处理操作
- 保持向后兼容性
- 提供清晰的扩展接口

### 5.2 性能优化
- 考虑大量数据处理的性能影响
- 优化错误处理逻辑

### 5.3 调试支持
- 提供详细的日志记录
- 支持调试模式
- 提供操作步骤的可视化

## 6. 测试需求

### 6.1 单元测试
- 测试各种操作类型的正确性
- 测试链式操作的顺序执行
- 测试错误处理机制

### 6.2 集成测试
- 测试与不同数据源的集成
- 测试配置文件的解析
- 测试端到端的数据流

### 6.3 边界测试
- 测试无效输入的处理
- 测试极端数值的处理
- 测试网络异常的处理

## 7. 维护需求

### 7.1 文档维护
- 保持操作类型的文档更新
- 提供使用示例和最佳实践
- 记录已知问题和解决方案

### 7.2 代码维护
- 保持代码的可读性和可维护性
- 定期重构和优化
- 遵循编码规范

## 8. 安全考虑

### 8.1 输入验证
- 严格验证所有输入参数
- 防止恶意配置导致的系统问题
- 限制可执行的操作类型

### 8.2 错误信息
- 避免在错误信息中泄露敏感信息
- 提供用户友好的错误提示
- 记录详细的调试信息

## 9. 未来规划

### 9.1 功能增强
- 支持更多数学运算（如幂运算、开方等）
- 支持字符串操作（如截取、替换等）
- 支持条件判断和分支处理

### 9.2 性能提升
- 实现操作缓存机制
- 支持并行处理
- 优化内存使用
